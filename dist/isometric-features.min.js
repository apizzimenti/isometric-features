/*! iso-game-features - v0.0.1 - 2016-07-26
* Copyright (c) 2016 ; Licensed MIT */
"use strict";function determineBounds(a){var b=a.sprite,c={};return b.tile.top.blocked?c.top=!0:c.top=!1,b.tile.left.blocked?c.left=!0:c.left=!1,b.tile.bottom.blocked?c.bottom=!0:c.bottom=!1,b.tile.right.blocked?c.right=!0:c.right=!1,c.allBounds=c.top||c.left||c.bottom||c.right,c}function isInBounds(a){var b=a.threeD.x,c=a.threeD.y,d=a.game,e=b>d.physics.isoArcade.bounds.backX&&b<d.physics.isoArcade.bounds.frontX,f=c>d.physics.isoArcade.bounds.backY&&c<d.physics.isoArcade.bounds.frontY;return e&&f}function direction(a){var b=a.sprite,c=b.body.frontX,d=b.body.frontY,e=a.map.tileMap,f=a.map.tileSize,g=Math.ceil(c/f)>=e.length-1?e.length-1:Math.ceil(c/f),h=Math.ceil(d/f)>=e[0].length-1?e[0].length-1:Math.ceil(d/f),i=b.direction,j=determineTileRadius(e.length,g),k=determineTileRadius(e.length,h),l=j.p,m=j.m,n=k.p,o=k.m;switch(b.row=g,b.col=h,b.tile.center=e[g][h],i){case 0:b.tile.top=e[l][h],b.tile.left=e[g][o],b.tile.right=e[g][n],b.tile.bottom=e[m][h];break;case 1:b.tile.top=e[g][o],b.tile.left=e[m][h],b.tile.right=e[l][h],b.tile.bottom=e[g][n];break;case 2:b.tile.top=e[m][h],b.tile.left=e[g][n],b.tile.right=e[g][o],b.tile.bottom=e[l][h];break;case 3:b.tile.top=e[g][n],b.tile.left=e[l][h],b.tile.right=e[m][h],b.tile.bottom=e[g][o]}b.loadTexture(a.keys[i])}function determineTileRadius(a,b){return{m:b>0?b-1:b,p:a-1>b?b+1:b}}function manipulateDirection(a,b){var c=20,d=a.sprite;switch(b){case 0:d.body.velocity.x=c,d.body.velocity.y=0,d.direction=0;break;case 1:d.body.velocity.x=0,d.body.velocity.y=-c,d.direction=1;break;case 2:d.body.velocity.x=-c,d.body.velocity.y=0,d.direction=2;break;case 3:d.body.velocity.x=0,d.body.velocity.y=c,d.direction=3}}function determineDirections(a){for(var b,c,d,e,f=[],g=0;g<a.length;g++){if(!(g+1<a.length))return f;b=a[g].x,c=a[g].y,d=a[g+1].x,e=a[g+1].y,b>d?f.push(2):d>b?f.push(0):c>e?f.push(1):e>c&&f.push(3)}}function Debug(a,b){this.game=a,this.x=b/2,this.y=20,this.color="#FFF",this.on=!0}function dim(a,b,c){return c?a*(b-(c+1)):a-b}function Mouse(a,b,c){this.game=a,this.map=b,this.group=c,this.pos=new Phaser.Plugin.Isometric.Point3;var d=this.game.input.mousePointer.x,e=this.game.input.mousePointer.y;this.twoD=new Phaser.Point(d,e),this.threeD=this.game.iso.unproject(this.twoD,this.pos),this["switch"]=!1,this.tile={},this.mouse=this.game.input}function keymap(a,b){return b.cursors=a.input.keyboard.createCursorKeys(),b.game.input.keyboard.addKeyCapture([Phaser.Keyboard.LEFT,Phaser.Keyboard.RIGHT,Phaser.Keyboard.UP,Phaser.Keyboard.DOWN]),{esc:a.input.keyboard.addKey(Phaser.Keyboard.ESC),space:a.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR)}}function keymapTrack(a,b){var c=50,d=a.sprite;d.body.velocity.z=0,b.cursors.up.isDown?(d.body.velocity.y=-c,d.direction=1):b.cursors.down.isDown?(d.body.velocity.y=c,d.direction=3):d.body.velocity.y=0,b.cursors.left.isDown?(d.body.velocity.x=-c,d.direction=2):b.cursors.right.isDown?(d.body.velocity.x=c,d.direction=0):d.body.velocity.x=0}function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function Animal(a,b,c,d,e,f,g,h){var i;this.type="animal",this.species=h||"none",this.game=a,this.scope=b,this.keys=e,this.map=g;var j=c*g.tileSize,k=d*g.tileSize;this.sprite=this.game.add.isoSprite(j,k,0,e[0],null,f),(i=this.sprite.anchor).set.apply(i,_toConsumableArray(globals.anchor)),this.game.physics.isoArcade.enable(this.sprite),this.sprite.enableBody=!0,this.sprite.body.collideWorldBounds=!0,this.sprite.visible=!1,this.scanned=!1,this.scan=new Phaser.Signal,this.listen(),this.sprite.tile={},direction(this),this.timedMovement()}function createAnimals(a,b,c,d,e,f,g){for(var h,i,j,k=[],l=f.tileMap.length-1,m=0;b>m;m++)i=Math.floor(Math.random()*l),j=Math.floor(Math.random()*l),h=new Animal(c,a,i,j,d,e,f,g[m]),h.id=m,k.push(h);return k}function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function Item(a,b,c){this.keys=[b,b,b,b],this.game=a,this.key=b,this.inventory=c,this.text={},this.inventorySprite={},this.sprite={},this.sprite.tile={},this.sprite.direction=0,this.map=this.inventory.map}function Map(a,b,c,d,e){var f,g=[],h=[],i=this.createTileMap(e),j=dim(d,e,1);this.game=a,this.tileSet=c,this.tileSize=d,this.mapSize=e,this.group=b;for(var k=0;k<i.length;k++){g[k]=[],h[k]=[];for(var l=0;l<i[0].length;l++)f=this.game.add.isoSprite(k*this.tileSize,l*this.tileSize,0,this.tileSet,globals.mapTileKey[i[k][l]],this.group),l>i.length-2||1>k||k>i.length-2||1>l?(f.tint=5709655,f.blocked=!0,h[k].push(0)):(f.blocked=!1,f.tint=5709655,h[k].push(1)),f.discovered=!1,f.type="tile",f.anchor.set(.5,1),f.smoothed=!1,f.row=k,f.col=l,g[k][l]=f,f.compareTo=function(a){var b=this.row===a.row,c=this.col===a.col;return b&&c?!0:void 0}}this.game.physics.isoArcade.bounds.frontX=j,this.game.physics.isoArcade.bounds.frontY=j,this.game.physics.isoArcade.bounds.backX=0,this.game.physics.isoArcade.bounds.backY=0,this.tileMap=g,this.blocked=h}function ContextMenu(a){this.Inventory=a,this.game=this.Inventory.game,this.mouse=this.Inventory.mouse,this.items=this.Inventory.items}function Guide(a,b){var c=this;this.raw={},this.raw.guide=document.getElementById(a),this.raw.game=document.getElementById(b),this.raw.canvas=this.raw.game.getElementsByTagName("canvas")[0],this.raw.guideHtml=this.raw.guide.innerHTML,this.raw.offsetTop=this.raw.canvas.offsetTop,this.raw.offsetLeft=this.raw.canvas.offsetLeft,this.raw.on=!1,$(document).ready(function(){c.guideElement=$("#"+a),c.guideElement.css("display","none"),c.button()})}function Inventory(a,b,c,d,e,f,g){this.game=a,this.width=c,this.height=d,this.mouse=e,this.escape=f,this.times=0,this.map=b,this.items=[],this.itemsRow=[];var h=a.add.graphics(0,0),i=a.add.group(),j=260,k=300,l=65,m=60;this.i=k,this.j=j,i.fixedToCamera=!0,i.enableBody=!0,this.menuGroup=i,this.itemGroup=g,h.fixedToCamera=!0,h.lineStyle(2,16711680,1),h.beginFill(16711680,.4),h.drawRect(c-j,d-k,j,k),this.graphics=h,this.area={},this.area.width=j,this.area.height=k,this.element={},this.element.width=l,this.element.height=m,window.graphics=h,this.messages=new Message(this.game,this.height,14),this.contextMenu=new ContextMenu(this),this.onClick()}function Message(a,b,c){var d=this;this.game=a,this.y=b,this.message="",this.fontSize=c,this.style={font:c+"px Courier",fill:"#FFFFFF"},this.alert=new Phaser.Signal,this.alert.add(function(){d.display()})}function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function Player(a,b,c,d,e,f){var g;this.type="player",this.map=f;var h=b*this.map.tileSize,i=c*this.map.tileSize;this.game=a,this.keys=d,this.sprite=this.game.add.isoSprite(h,i,0,d[0],null,e),(g=this.sprite.anchor).set.apply(g,_toConsumableArray(globals.anchor)),this.sprite.body.collideWorldBounds=!0,this.game.camera.follow(this.sprite),this.sprite.direction=0,this.sprite.tile={},this.game.physics.isoArcade.enable(this.sprite),this.sprite.body.bounce=new Phaser.Plugin.Isometric.Point3(.5,.5,.5),direction(this)}Debug.prototype.fps=function(){this.on&&this.game.debug.text(this.game.time.fps,this.x,this.y,this.color)},Debug.prototype.mousePos=function(a){this.on&&this.game.debug.text(a.tile.row+", "+a.tile.col,this.x,this.y,this.color)},Debug.prototype.sprite=function(a){var b=this;if(this.on){var c=function(a){b.game.debug.text(a.sprite.row+", "+a.sprite.col,b.x,b.y,b.color);try{b.game.debug.body(a.sprite.tile.top,"#FF0000",!1),b.game.debug.body(a.sprite,"#FFFFFF",!1);for(var c in a.sprite.tile)a.tile.hasOwnProperty(c)&&"top"!==c&&b.game.debug.body(a.tile[c],"#FFDD00",!1)}catch(d){console.log("%cSprite has not loaded yet","color: red")}};if(Array.isArray(a)){var d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value;c(i)}}catch(j){e=!0,f=j}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}}else c(a)}},Debug.prototype.tiles=function(a){if(this.on)for(var b=0;b<a.length;b++)for(var c=0;c<a[0].length;c++){var d=a[b][c];d.blocked&&this.game.debug.body(a[b][c],"#FFDD00",!1)}},Debug.prototype["switch"]=function(){this.on=!this.on};var globals={anchor:[.5,0],mapTileKey:["grass","sand","sandstone"],tween:[1e3,Phaser.Easing.Linear.None,!0,0,0,!1]};Mouse.prototype.update=function(){this.twoD.x=this.game.input.mousePointer.x,this.twoD.y=this.game.input.mousePointer.y,this.threeD=this.game.iso.unproject(this.twoD,this.pos);var a=this.game.physics.isoArcade.bounds.backX,b=this.game.physics.isoArcade.bounds.backY,c=this.game.physics.isoArcade.bounds.frontX,d=this.game.physics.isoArcade.bounds.frontY;this.inBounds=this.threeD.x>a&&this.threeD.x<c&&this.threeD.y>b&&this.threeD.y<d},Mouse.prototype.selected=function(){var a=this;this.inBounds?this.group.forEach(function(b){if("tile"===b.type){var c=b.isoBounds.containsXY(a.threeD.x+a.map.tileSize,a.threeD.y+a.map.tileSize);c?(a.tile=b,a.row=a.tile.row,a.col=a.tile.col,b.tint=10025880,b.alpha=1.3+Math.sin(.007*a.game.time.now),a.tween=a.game.add.tween(b).to({isoZ:5},20,Phaser.Easing.Linear.None,!0),a.tweened=!0):(a.tweened&&(a.tween.stop(),a.tweened=!a.tweened,b.isoZ=0),b.discovered?b.tint=16777215:b.tint=5709655,b.alpha=1)}}):this.reset()},Mouse.prototype.reset=function(){var a=this;this.group.forEach(function(b){"tile"===b.type&&(b.discovered?b.tint=16777215:b.tint=5709655,b.alpha=1,b.isoZ=0,a.game.canvas.style.cursor="default")})},Animal.prototype.isVisible=function(a){var b=a.row,c=a.col,d=this.sprite.row,e=this.sprite.col,f=d>=b-1&&b+1>=d,g=e>=c-1&&c+1>=e;f&&g&&(this.sprite.visible=!0),this.sprite.tile.center.discovered?this.sprite.visible=!0:this.sprite.visible=!1},Animal.prototype.timedMovement=function(){var a=this,b=0;this.rand=3*Math.random(),this.loopedMovement=this.game.time.events.loop(3*Phaser.Timer.SECOND+this.rand,function(){b=Math.floor(4*Math.random()),a.rand=3*Math.random(),manipulateDirection(a,b)})},Animal.prototype.listen=function(){var a=this;this.scan.add(function(){a.scope.$emit("scanned",{animal:a})}),this.scope.$on("pathfind",function(b,c){a.pathfind(c.row,c.col)})},Animal.prototype.pathfind=function(a,b){var c=this,d=new EasyStar.js,e=this.sprite.row,f=this.sprite.col,g=[];d.setGrid(this.map.blocked),d.setAcceptableTiles([1]),d.setIterationsPerCalculation(1e3),d.findPath(e,f,a,b,function(a){a?(c.game.time.events.remove(c.loopedMovement),g=determineDirections(a),c.followDirection(!0,a,g)):console.log("path not found")}),d.calculate()},Animal.prototype.followDirection=function(a,b,c){var d,e=this,f=this.map.tileSize,g=b[0].x,h=b[0].y,i=g*f,j=h*f,k=0===c.length||1===b.length;if(a){var l;this.sprite.tween=(l=this.game.add.tween(this.sprite)).to.apply(l,[{isoX:i,isoY:j}].concat(_toConsumableArray(globals.tween))),this.sprite.tween.onComplete.add(function(){e.sprite.direction=c[0],b.splice(0,1),c.splice(0,1),e.followDirection(!1,b,c)})}else if(a||k)!a&&k&&this.timedMovement();else{var m;d=this.game.add.tween(this.sprite),this.sprite.tween.chain((m=d).to.apply(m,[{isoX:i,isoY:j}].concat(_toConsumableArray(globals.tween)))),d.onComplete.add(function(){e.sprite.direction=c[0],b.splice(0,1),c.splice(0,1),e.followDirection(!1,b,c)})}},Item.prototype.action=function(){console.log("NoActionMethod: "+this.key+" is using the builtin action method")},Item.prototype.threeDInitialize=function(){var a;(a=this.sprite.anchor).set.apply(a,_toConsumableArray(globals.anchor)),this.sprite.body.collideWorldBounds=!0,this.game.physics.isoArcade.enable(this.sprite),this.sprite.enableBody=!0,this.sprite.tile={},this.sprite.direction=0,this.sprite.body.immovable=!0,this.setting=!0,direction(this)},Map.prototype.createTileMap=function(a){for(var b=[],c=0;a>c;c++){b[c]=[];for(var d=0;a>d;d++){var e=Math.floor(3*Math.random());e>0?b[c][d]=e:b[c][d]=0}}return b},ContextMenu.prototype.createContextMenu=function(){var a=this,b=this.mouse.twoD.x,c=this.mouse.twoD.y,d=this.game.add.graphics(0,0);d.fixedToCamera=!0,d.lineStyle(2,16776960,1),d.beginFill(16776960,.4),this.graphics=d,this.menu=this.graphics.drawRect(b,c,100,150),this.mouse.mouse.onDown.add(function(){a.menu.destroy()})},Guide.prototype.button=function(){var a=this,b=document.createElement("button"),c=document.createTextNode("i"),d="guideButton",e="#"+d;b.id=d,b.appendChild(c),this.raw.game.appendChild(b),this.raw.guideButton=b,$(e).css({position:"absolute",top:this.raw.offsetTop+20,left:this.raw.offsetLeft+20,"background-color":"transparent",color:"#FFF",border:"none","font-family":"Courier","font-size":"20px"}),$(e).hover(function(){$(e).css({cursor:"pointer"})}),$(e).click(function(){$(e).css({outline:"none"}),a.raw.on?($(e).empty(),a.raw.on=!1):($(e).append(a.raw.guideHtml),a.raw.on=!0)})},Inventory.prototype.addItem=function(a){var b=this.element.width,c=this.element.height,d=this.width-this.j,e=this.height-this.i,f=a.key;if(a.inventorySprite=this.game.add.sprite(d,e,a.key,null,this.menuGroup),a.inventorySprite.width=b,a.inventorySprite.height=c,a.inventorySprite.row=(this.area.height-this.i)/c,a.inventorySprite.col=(this.area.width-this.j)/b,a.inventorySprite.inputEnabled=!0,a.inventorySprite.input.useHandCursor=!0,a.text=this.game.add.text(d,e,f,{font:"Courier",fontSize:12,fill:"white"}),a.text.fixedToCamera=!0,this.j-=b,this.itemsRow.push(a),this.items[a.inventorySprite.row]=this.itemsRow,this.count++,0===this.j)this.count=0,this.i-=c,this.j=this.area.width,this.items[a.inventorySprite.row+1]=[],this.itemsRow=[];else if(0===this.i)throw new RangeError("Number of sprites exceeds the number of available tiles.")},Inventory.prototype.addItems=function(a){var b=this;if(!Array.isArray(a))throw new Error("Use addItem for single items.");a.forEach(function(a){b.addItem(a)})},Inventory.prototype.onClick=function(){var a=this;this.game.input.onDown.add(function(){a.mouse["switch"]?a.placeItem():a.click()}),this.escape.onDown.add(function(){a.mouse["switch"]=!1,a.mouse.reset(),a.reset()})},Inventory.prototype.click=function(){var a=this;this.game.canvas.oncontextmenu=function(b){b.preventDefault(),a.contextMenu.createContextMenu()};var b=this.width-this.area.width,c=this.height-this.area.height,d=this.mouse.twoD.x-b,e=this.mouse.twoD.y-c;if(this.mouse.twoD.x>b&&this.mouse.twoD.y>c){var f,g=Math.floor(d/this.element.width),h=Math.floor(e/this.element.height);this.items[h][g]&&(f=this.items[h][g],this.currentItem&&(this.currentItem.inventorySprite.tint=16777215,this.currentItem.inventorySprite.clicked=!1,this.currentItem.inventorySprite.useHandCursor=!0),this.mouse["switch"]=!0,f.inventorySprite.clicked=!0,f.inventorySprite.tint=16768256,f.text.tint=16768256,this.currentItem=f)}},Inventory.prototype.reset=function(){this.menuGroup.forEach(function(a){a.input.useHandCursor=!0,a.tint=16777215,a.clicked&&(a.clicked=!1)})},Inventory.prototype.placeItem=function(){var a,b,c=this.mouse.map.tileSize,d=this.mouse.threeD.x-this.mouse.threeD.x%c,e=this.mouse.threeD.y-this.mouse.threeD.y%c,f=this.currentItem,g=f.key,h=this.mouse.tile,i="Sorry, you can't place the "+g+" there. Choose a place that you've already seen!";h.discovered&&isInBounds(this.mouse)?(a=f.inventorySprite.row,b=f.inventorySprite.col,f.sprite=this.game.add.isoSprite(d,e,0,g,null,this.itemGroup),f.threeDInitialize(),f.action(),f.inventorySprite.destroy(),f.text.destroy(),this.items[a][b]=null,this.mouse.reset(),this.mouse["switch"]=!1):this.messages.add(i)},Message.prototype.add=function(a){this.message=a,this.alert.dispatch()},Message.prototype.display=function(){var a=this,b=this.format(this.message);this.text=this.game.add.text(b.width,b.height,b.message,this.style),this.text.alpha=0,this.text.fixedToCamera=!0,this.game.add.tween(this.text).to({alpha:1},500,Phaser.Easing.Linear.None,!0,0,0,!1),this.game.time.events.add(5*Phaser.Timer.SECOND,function(){a.game.add.tween(a.text).to({alpha:0},500,Phaser.Easing.Linear.None,!0,0,0,!1)})},Message.prototype.format=function(a){for(var b=0,c=[],d=a.length%60?a.length-a.length%60:0,e=0;e<a.length;e++)if(e%60||0===e){if(0===d&&e===a.length-1)c.push(a.slice(b,a.length));else if(e>d&&0!==d){c.push(a.slice(b,a.length));break}}else c.push(a.slice(b,e)+"\n"),b=e;return{width:10,height:this.y-c.length*(1.8*this.fontSize),message:c.join(" ")}},Player.prototype.visionRadius=function(){var a,b,c={},d=this.sprite.row,e=this.sprite.col;for(a=d-1;d+2>a;a++)for(b=e-1;e+2>b;b++)c=this.map.tileMap[a][b],c.tint=16777215,c.discovered=!0},Player.prototype["float"]=function(){this.sprite.isoZ=5+Math.sin(.005*this.game.time.now)};